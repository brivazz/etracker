```
botapp/
├── bot.py               <- запуск бота, оркестратор
├── orchestrator.py      <- регистрирует все обработчики
├── handlers/
│   ├── start_handler.py
│   ├── expense_handler.py
│   ├── stats_handler.py
│   ├── edit_handler.py
│   └── state_handler.py
└── utils/
    └── message_builder.py
```

```
your_project/
│
├── db/
│   ├── __init__.py
│   ├── connection.py          # подключение к SQLite
│   ├── schema.py              # инициализация базы
│   ├── expense_repository.py  # CRUD операции с таблицей expenses
│   └── user_repository.py     # работа с user_settings
│
├── services/
│   ├── __init__.py
│   ├── statistics.py          # агрегаты, отчёты
│   └── export.py              # экспорт в CSV
│
└── main.py
```

### Пример использования
```
$ python main.py init
$ python main.py add
или
$ python main.py add 350.00 "продукты" --note "магнит"
$ python main.py show
```

### ✅ Примеры использования

**Расходы за май**
```
$ python main.py filter --from-date 2025-05-01 --to-date 2025-05-31
```
**Статистика по категориям**
```
$ python main.py stats
```
**Экспорт в CSV**
```
$ python main.py export
или
$ python main.py export --filename my_expenses.csv
```
### Проект умеет:
- 📥 Добавлять траты,
- 🔎 Фильтровать по датам,
- 📊 Показывать статистику,
- 📤 Экспортировать в CSV.


### ✅ Пример запуска
```
$ python main.py plot
```
- Откроется интерактивное окно с графиком расходов по категориям. Поддерживаются русские категории, если они добавлены при добавлении трат.


### Теперь бот умеет:
- принимать расходы с выбором категории,
- повторять последние траты,
- показывать статистику.
- Отображает расходы по категориям в виде красивой диаграммы.
- Отправляет PNG-файл прямо в Telegram.


x🔧 Router
умеет регистрировать хендлеры с @router.message(...) и @router.callback(...),

поддерживает Enum, str, regex, объединение значений и автоматическую маршрутизацию,

оборачивает хендлеры в middleware (например, inject_user()),

при вызове хендлера распознаёт параметры коллбэка через parse_callback_data() и подставляет их.



🤖 BotService
регистрирует все callback и message хендлеры централизованно в register_handlers(),

использует оркестраторы (AddOrchestrator, StatsOrchestrator, и т.п.) как единицы бизнес-логики,

умеет сам разруливать входящие callback’и по Enum + params,

добавлен @router.message("/start"), и он работает как обычный хендлер.


📦 Модульность:
Модули handlers, orchestrators, services — разделены,

Используется autoimport() — удобный способ подгрузить все модули хендлеров без ручного импорта,

Хендлеры регистрируются через один BotService, что облегчает тестирование и масштабирование.

╔════════════════════════════════════════════════════════╗
║                    START / IDLE                       ║
║   (Кнопка /start → main_menu_keyboard)                ║
╚════════════════════════════════════════════════════════╝
             │
             ▼
┌────────────────────────────────────────────────────────┐
│                      Главное меню                      │
│ "➕ Добавить трату"          →  ADD_EXPENSE             │
│ "📊 Статистика"             →  SHOW_STATS              │
│ "📄 История трат"           →  SHOW_HISTORY            │
│ "🔁 Повторить последнюю"    →  REPEAT_LAST_EXPENSE     │
│ "✏️ Редактировать последнюю"→  EDIT_LAST_EXPENSE       │
│ "🗑 Удалить последнюю"       →  DELETE_LAST_EXPENSE     │
└────────────────────────────────────────────────────────┘
             │
             ▼
╔══════════════════════════════════════════════════════╗
║                  ADD_EXPENSE                         ║
║  → Кнопки категорий или                              ║
║  → "➕ Добавить категорию" → ADD_CATEGORY             ║
║  → "↩️ Назад" → Главное меню (IDLE / START)          ║
╚══════════════════════════════════════════════════════╝
             │
             ▼
╔══════════════════════════════════════════════════════╗
║           WAITING_FOR_CATEGORY_SELECTION             ║
║   (Пользователь выбрал категорию)                    ║
╚══════════════════════════════════════════════════════╝
             │
             ▼
╔══════════════════════════════════════════════════════╗
║              WAITING_FOR_AMOUNT                      ║
║   (Пользователь вводит сумму)                        ║
╚══════════════════════════════════════════════════════╝
             │
             ▼
╔══════════════════════════════════════════════════════╗
║                EXPENSE_RECORDED                      ║
║     Показываем подтверждение и возвращаем в меню     ║
╚══════════════════════════════════════════════════════╝

Доп. состояния:
────────────────────────────────────────────────────────
╔══════════════════════════════════════════════════════╗
║                EDIT_LAST_EXPENSE                     ║
║   → выбор новой категории → WAITING_FOR_CATEGORY_EDIT║
║   → ввод новой суммы     → WAITING_FOR_AMOUNT_EDIT   ║
╚══════════════════════════════════════════════════════╝

╔══════════════════════════════════════════════════════╗
║                DELETE_LAST_EXPENSE                   ║
║     → подтверждение → удаление → IDLE                ║
╚══════════════════════════════════════════════════════╝

╔══════════════════════════════════════════════════════╗
║                REPEAT_LAST_EXPENSE                   ║
║     → дублирование → EXPENSE_RECORDED                ║
╚══════════════════════════════════════════════════════╝

| Кнопка                     | Состояние FSM            | Пояснение                                |
| -------------------------- | ------------------------ | ---------------------------------------- |
| ➕ Добавить трату           | `ADD_EXPENSE`            | Показывает категории                     |
| Название категории         | `WAITING_FOR_AMOUNT`     | После выбора — ожидаем сумму             |
| Сумма                      | `EXPENSE_RECORDED`       | Подтверждение                            |
| ✏️ Редактировать последнюю | `EDIT_LAST_EXPENSE`      | Переход к выбору поля для редактирования |
| Повторить последнюю        | `REPEAT_LAST_EXPENSE`    | Повторный ввод                           |
| Удалить последнюю          | `DELETE_LAST_EXPENSE`    | Запрос на удаление                       |
| 📊 Статистика              | `SHOW_STATS` (не явно)   | Не меняет состояние                      |
| 📄 История трат            | `SHOW_HISTORY` (не явно) | Не меняет состояние                      |
